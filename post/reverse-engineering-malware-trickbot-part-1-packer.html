<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />


	<title>Reverse engineering malware: TrickBot (part 1 - packer)</title>


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:title" content="Reverse engineering malware: TrickBot (part 1 - packer)" />
<meta name="twitter:description" content="In this post, I will show how to unpack, dump, and analyze a TrickBot sample. The goal isto show the reader the techniques used by malware analysts and why they are used, includingwrong assumptions...">

<meta name="description" content="In this post, I will show how to unpack, dump, and analyze a TrickBot sample. The goal isto show the reader the techniques used by malware analysts and why t...">


	<meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o">


<link rel="icon" href="/assets/favicon.png">
<link rel="apple-touch-icon" href="/assets/touch-icon.png">
<link href="https://fonts.googleapis.com/css?family=Karla" rel="stylesheet">
<link rel="stylesheet" href="/assets/core.css">
<link rel="canonical" href="/post/reverse-engineering-malware-trickbot-part-1-packer">
<link rel="alternate" type="application/atom+xml" title="qmemcpy - random bits of reverse engineering" href="/feed.xml" />



   
	</head>

	<body>

		<aside class="logo">

	
	

	<a href="/">
		<img src="/assets/command_line.png" class="gravatar">
	</a>

</aside>


		<main>
			<article>

	<div class="center">
		<h1>Reverse engineering malware: TrickBot (part 1 - packer)</h1>
		<time>October 1, 2017</time>
	</div>

	<div class="divider"></div>

	<p>In this post, I will show how to unpack, dump, and analyze a TrickBot sample. The goal is
to show the reader the <em>techniques</em> used by malware analysts and <em>why</em> they are used, including
wrong assumptions, mistakes, and everything that happens in real-life malware analysis, in contrast
to the usual tutorials, where everything goes right (and if something goes wrong, the reader is left alone).</p>

<p>The requirements are, as usual, basic reverse engineering skills, a VM, and IDA.</p>

<p><strong>Sample hash</strong>: 01e771dc6cf9572eac3d87120d7a7d1ff95fdc1499b668c7fde2919e0f685256</p>

<hr />

<p>After opening the sample in IDA, we can quickly see that the sample does a bunch of boring initialization
(deobfuscating API call names/strings, finding functions, etc):</p>

<p><img src="https://i.imgur.com/IX4W4dU.png" alt="boring initialization" /></p>

<p>Then, it proceeds to call
<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683219%28v=vs.85%29.aspx">GetProcessMemoryInfo</a>:</p>

<p><img src="https://i.imgur.com/gGkavwe.png" alt="anti-debug" /></p>

<p>A quick Google search yields <a href="https://www.gironsec.com/blog/2015/06/anti-debugger-trick-quicky/">this anti-debug technique</a>, so if
your debugger is caught, just invert CF on the corresponding <code class="highlighter-rouge">ja</code> instruction and move on.<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup></p>

<p>Looking forward, you can see that the sample tries to create a mutex, and if it doesn’t exist, it relaunches itself
with <code class="highlighter-rouge">-l</code> as a command line parameter, and deletes itself. In the next run, the mutex already exists, so the other branch
is taken, which is the path that ultimately leads to infection:</p>

<p><img src="https://i.imgur.com/pwDFgYj.png" alt="infection mutex stuff" /></p>

<p>However, you don’t really need to let it launch another process, attach to it, etc. Just modify the control flow
so that it directly tries to infect you, to spare yourself a minute or two:</p>

<p><img src="https://i.imgur.com/oZLulzT.gif" alt="change EIP" /></p>

<p>As you can see, I selected the inverse branch, and used <kbd>Ctrl</kbd> + <kbd>N</kbd> to skip through the first step.</p>

<p>Now, the next function that is called is a bit scary:</p>

<p><img src="https://i.imgur.com/prAksF0.gif" alt="scary function" /></p>

<p>You don’t need to read nor understand all of that - if you do, you’re accomplishing the author’s goal - to distract
you from actual analysis. As you can see at the end of that GIF, there’s an API call: <code class="highlighter-rouge">CreateProcessA</code>, which suggests
that the sample is going to do a RunPE or something like that. You don’t care – all you want is the final, unpacked,
easy-to-analyze sample, and that’s what you’ll get.</p>

<p>To proceed, put a breakpoint on <code class="highlighter-rouge">CreateProcessA</code> (you can put it in <code class="highlighter-rouge">CreateProcessInternalW</code> if you’re unsure, as all <code class="highlighter-rouge">CreateProcess</code>
friends ultimately go through there), and run:</p>

<p><img src="https://i.imgur.com/KwAgXnT.png" alt="exception" /></p>

<p>Oops. Something broke. Sometimes, malware uses SEH to obfuscate the control flow, but if you try to open <code class="highlighter-rouge">Debugger</code> &gt; <code class="highlighter-rouge">Debugger windows</code> &gt; <code class="highlighter-rouge">SEH list</code>, you get an error:</p>

<p><img src="https://i.imgur.com/r0lWCrM.png" alt="no SEH" /></p>

<p>This suggests that the SEH list is empty, and that the exception is legit (i.e. something broke).
However, if you run the binary outside of a debugger, it infects you, so it must be us breaking something.</p>

<p>To find out, look at the faulting instruction:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>.text:0040286D mov     esi, [ebp+arg_0]
.text:00402870 mov     dl, [esi+edx] ; esi = 0, edx = 0xA -&gt; exception
</code></pre>
</div>

<p><code class="highlighter-rouge">esi</code> is <code class="highlighter-rouge">0</code>, but that’s obviously wrong - to find out what its original value should be, look at the instruction above:
<code class="highlighter-rouge">esi</code> comes from <code class="highlighter-rouge">arg_0</code>. Cross-reference the function to find out where the first parameter comes from, and you end up with:</p>

<p><img src="https://i.imgur.com/H9T47Dx.png" alt="important parameter" /></p>

<p><img src="https://i.imgur.com/mBimrU3.png" alt="important parameter function" /></p>

<p>As you can see, some global variable is zero. Cross-reference it to see where it gets set,
and select the <code class="highlighter-rouge">w</code> item (i.e. xref that writes to the variable):</p>

<p><img src="https://i.imgur.com/LJxhp8Z.png" alt="important variable - write" /></p>

<p>At first sight, it appears that the <code class="highlighter-rouge">GlobalAlloc</code> call is failing, but if you put a breakpoint and run the binary,
it never hits, and you still get the exception, which means that the other branch is taken - which, in turn, means
that <code class="highlighter-rouge">GetFileSize</code> is returning <code class="highlighter-rouge">-1</code>. But how can that be possible? The referenced file is the sample itself, why can
it not get its own size?</p>

<p>To find the answer, put a breakpoint on <code class="highlighter-rouge">GetFileSize</code>, re-launch the binary, and check the handle passed to the function, to
find out more about the file that’s causing problems:</p>

<p><img src="https://i.imgur.com/KwAgXnT.png" alt="exception" /></p>

<p>Snap! It doesn’t hit. If you look above, you’ll see:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  v151 = kernel32_CreateFileA(a1, 2147483648, 0, 0, 3, 0, 0);
  if ( v151 == -1 )
    return 0;
</code></pre>
</div>

<p>A-ha! That must be the part that’s returning. Putting a breakpoint on the call to <code class="highlighter-rouge">CreateFileA</code>, you see that’s what effectively
happens, and that <code class="highlighter-rouge">CreateFileA</code> returns <code class="highlighter-rouge">FFFFFFFF</code> - but why? <code class="highlighter-rouge">a1</code> is just the path to the sample itself, but <code class="highlighter-rouge">CreateFileA</code> can’t
get a handle to it.</p>

<p>If you look at the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa363858(v=vs.85).aspx">CreateFile documentation</a>,
you’ll see that the third parameter is <code class="highlighter-rouge">dwShareMode</code>, and here it is <code class="highlighter-rouge">0</code>, which means that the call is asking for full control over the file, without
allowing sharing with other processes:</p>

<blockquote>
  <p>Prevents other processes from opening a file or device if they request delete, read, or write access.</p>
</blockquote>

<p>However, our debugger has a handle to that file, and <code class="highlighter-rouge">CreateFileA</code> won’t close it - it’ll just complain that it can’t
get that handle, and return <code class="highlighter-rouge">-1</code>. Our assumption is further confirmed by checking <code class="highlighter-rouge">TIB.LastErrorValue</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>TIB[0000071C]:7EFDD000 dd 20h                                  ; LastErrorValue
</code></pre>
</div>

<p>As per the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms681382(v=vs.85).aspx">documentation</a>, <code class="highlighter-rouge">0x20</code> means
<code class="highlighter-rouge">ERROR_SHARING_VIOLATION</code> - which confirms our previous assumptions. To fix it, the simplest way (imo) is to put a breakpoint on
the <code class="highlighter-rouge">CreateFileA</code> call and change <code class="highlighter-rouge">dwShareMode</code> to <code class="highlighter-rouge">FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE</code> (all permissions), which
is <code class="highlighter-rouge">1 | 2 | 4</code> -&gt; <code class="highlighter-rouge">7</code>:</p>

<p><img src="https://i.imgur.com/zBUlPR0.gif" alt="it works" /></p>

<p>As you can see, <code class="highlighter-rouge">eax</code> now contains a valid <code class="highlighter-rouge">HANDLE</code>, and our <code class="highlighter-rouge">CreateProcessA</code> breapoint finally hits:</p>

<p><img src="https://i.imgur.com/ZrGlvxD.png" alt="createprocess breakpoint" /></p>

<p>It is creating a process using <code class="highlighter-rouge">CREATE_SUSPENDED</code>, which smells a lot like RunPE / process hollowing / whatever you want to call it. Therefore, we
risk it and put a breakpoint on <code class="highlighter-rouge">ntdll_NtWriteVirtualMemory</code> and <code class="highlighter-rouge">ntdll_NtResumeThread</code>; the former would supposedly be used to write the PE,
while the latter to execute the thread that’s going to run the written bytes. The breakpoint on <code class="highlighter-rouge">ntdll_NtWriteVirtualMemory</code> might seem unnecessary, but it
is quite necessary, because if you manage to catch the non-memory-mapped PE file before it’s written, you can very easily dump it and further reversing
gets much easier.</p>

<p>Going forward, if you run the binary, the <code class="highlighter-rouge">NtWriteVirtualMemory</code> breakpoint will hit:</p>

<p><img src="https://i.imgur.com/CODq3rD.png" alt="ntwritevirtualmemory" /></p>

<p>If you check the <code class="highlighter-rouge">Buffer</code> parameter, you see:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>debug015:00365C80 db  4Dh ; M
debug015:00365C81 db  5Ah ; Z
debug015:00365C82 db  90h
debug015:00365C83 db    0
</code></pre>
</div>

<p>Bingo! Now, <a href="/post/manually-dumping-pe-files-from-memory">dump that</a> and kill the current debugging session.</p>

<p><em>To be continued…</em></p>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>This “anti-debug” used to catch Cuckoo Sandbox as well (in my experience, at least).&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;&#xfe0e;</a></p>
    </li>
  </ol>
</div>


</article>

<div class="page-navigation">
	
		<a class="home" href="/" title="Back to Homepage">Home</a>
  
		<span> &middot; </span>
    <a class="prev" href="/post/manually-dumping-pe-files-from-memory" title="PREV: Manually dumping PE files from memory">&gt;&gt;</a>
  
</div>

		</main>

		<div class="footer">
  <span class="block">Made with &hearts; using <a href="http://jekyllrb.com/">Jekyll</a> &amp; <a href="https://github.com/heiswayi/the-plain" title="The Plain theme by Heiswayi Nrird">The Plain</a> &middot; &lt;/&gt; on <a href="https://github.com/qmemcpy" title="Hosted on GitHub">GitHub</a></span>
  <span class="block">&copy; 2017 qmemcpy</span>
</div>

		<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99919043-1', 'auto');
  ga('send', 'pageview');

</script>


	</body>

</html>
